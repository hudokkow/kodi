language: cpp
#dummy commit to test

# Define the build matrix
#
# Travis defaults to building on Ubuntu Precise when building on Linux. We need Trusty in order to get up
# to date versions of cmake and g++.
#
matrix:
  include:
    - os: linux
      dist: trusty    
      sudo: required
      compiler: gcc
      cache: ccache
      env: ADDONS=adsp CACHE_NAME=gcc
    - os: linux
      dist: trusty    
      sudo: required
      compiler: clang
      cache: ccache
      env: ADDONS=adsp CACHE_NAME=clang
    - os: osx
      osx_image: xcode8
      cache: ccache
      env: ADDONS=adsp CACHE_NAME=osx8
    - os: osx
      osx_image: xcode7.3
      cache: ccache
      env: ADDONS=adsp CACHE_NAME=osx7.3
  fast_finish: true

# Prepare system
#
# Prepare the system to install prerequisites or dependencies
#
before_install:
### Linux
#
# export line below prunes non-root Python from PATH on linux systems.
# Solves https://github.com/travis-ci/travis-ci/issues/4948
# See https://github.com/travis-ci/travis-ci/issues/5326 for solution info
#
# Add team-xbmc/xbmc-ppa-build-depends for some dependencies and ppa:wsnipex/vaapi for libda-dev 1.6.0.
# Stupid libda-dev 1.3.0 does not work on Trusty.
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      export PATH=$(echo $PATH | tr ':' "\n" | sed '/\/opt\/python/d' | tr "\n" ":" | sed "s|::|:|g") &&
      sudo add-apt-repository -y ppa:team-xbmc/xbmc-ppa-build-depends &&
      sudo add-apt-repository -y ppa:wsnipex/vaapi &&
      sudo add-apt-repository -y ppa:nschloe/cmake-nightly &&
      sudo apt-get update -qq;
    fi

### OSX
#
# Some of the OS X images don't have cmake, contrary to what people 
# on the Internet say
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then which cmake || brew update        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then which cmake || brew install cmake ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then which ccache || brew update        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then which ccache || brew install ccache ; fi

install:
### Linux
#
#Install any prerequisites or dependencies necessary to run our builds
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      sudo apt-get install -qq automake autopoint build-essential cmake ccache curl default-jre gawk gdb gdc
      gettext git-core gperf libasound2-dev libass-dev libbz2-dev libcap-dev libcdio-dev libcrossguid-dev libcurl3
      libcurl4-openssl-dev libdbus-1-dev libfontconfig-dev libegl1-mesa-dev libfreetype6-dev libfribidi-dev libgif-dev
      libiso9660-dev libjpeg-dev libltdl-dev liblzo2-dev libmicrohttpd-dev libmodplug-dev libmysqlclient-dev libnfs-dev
      libpcre3-dev libplist-dev libpng-dev libpulse-dev libsdl2-dev libsmbclient-dev libsqlite3-dev libssh-dev
      libssl-dev libtag1-dev libtinyxml-dev libtool libudev-dev libusb-dev libva-dev libvdpau-dev
      libxml2-dev libxmu-dev libxrandr-dev libxrender-dev libxslt1-dev libxt-dev libyajl-dev mesa-utils
      nasm pmount python-dev python-imaging python-sqlite swig unzip uuid-dev yasm zip zlib1g-dev;
    fi

# Prepare builds
#
before_script:

### Linux
#
  - if [[ "$ADDONS" == "adsp" || "$ADDONS" == "audiodecoder" || "$ADDONS" == "audioencoder" || "$ADDONS" == "inputstream" ||
          "$ADDONS" == "peripheral" || "$ADDONS" == "pvr" || "$ADDONS" == "screensaver" || "$ADDONS" == "visualization" ]]; then
      cd $TRAVIS_BUILD_DIR/project/cmake/addons &&
      mkdir -p build &&
      cd build/ &&
      cmake ../bootstrap -DCMAKE_BUILD_TYPE=Debug &&
      make -j3;
    fi

# Actually build
#
script:
  - if [[ "$ADDONS" == "adsp" || "$ADDONS" == "audiodecoder" || "$ADDONS" == "audioencoder" || "$ADDONS" == "inputstream" ||
          "$ADDONS" == "peripheral" || "$ADDONS" == "pvr" || "$ADDONS" == "screensaver" || "$ADDONS" == "visualization" ]]; then
      cd $TRAVIS_BUILD_DIR/ &&
      mkdir -p build &&
      cmake -DADDONS_TO_BUILD="$ADDONS".* -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=../addons $TRAVIS_BUILD_DIR/project/cmake/addons &&
      make -j3;
    fi

# Disable annoying emails
#
notifications:
  email: false
